\documentclass{beamer}
\usepackage{graphicx}
\usepackage{multicol}
\usepackage{tikz}
\usepackage{caption}
\setbeamertemplate{caption}{\raggedright\insertcaption\par}
\usepackage[font={small}]{caption}
\usetheme{Madrid}
\usecolortheme{default}

\setbeamertemplate{caption}[default]
\makeatletter
\setbeamertemplate{frametitle}
{
    \ifbeamercolorempty[bg]{frametitle}{}{\nointerlineskip}
    \@tempdima=\textwidth
    \advance\@tempdima by\beamer@leftmargin
    \advance\@tempdima by\beamer@rightmargin
    \vskip1ex
    \begin{beamercolorbox}[sep=8pt,center,colsep=-4bp,rounded=true]{frametitle}
        \usebeamerfont{frametitle}
        \vbox{}\vskip-1ex
        \if@tempswa\else\csname beamer@ftecenter\endcsname\fi
        \strut\insertframetitle\strut\par
        {
            \ifx\insertframesubtitle\@empty
            \else
            {\usebeamerfont{framesubtitle}\usebeamercolor[fg]{framesubtitle}\insertframesubtitle\strut\par}%
            \fi
        }
        \vskip-1ex
        \if@tempswa\else\vskip-.3cm\fi
    \end{beamercolorbox}
}
\makeatother

\setbeamertemplate{caption}{\raggedright\insertcaption\par}
\title{I love math but does she love me?}
\subtitle{The analysis of PISA 2012 data set. We investigate the correlation between liking mathematics and test scores.}
\author[M. Futrega, \L. Rajkowski]{Micha\l\ Futrega and \L ukasz Rajkowski}
\institute[MIM UW]{Faculty of Mathematics, University of Warsaw}
\date{\today}


\setbeamertemplate{section in toc}{\inserttocsectionnumber.~\inserttocsection}
\beamertemplatenavigationsymbolsempty

\newcommand\AddButton{
\setbeamertemplate{background canvas}{
\begin{tikzpicture}[remember picture,overlay]
\node[anchor=west] at ([yshift=20pt,xshift=1em]current page.south west)
  {\hyperlink{toc}{\beamergotobutton{Table of contests}}};
\end{tikzpicture}
  }
}

\begin{document}
%%% title page %%%
\begin{frame}
    \titlepage
    \center{We have observed that country where liking mathematics goes hand in hand with test results is ranked higher than country where there is no such correlation. We use archivist so you can easily download any of plots.}
\end{frame}

\SweaveOpts{concordance=TRUE}
<<echo=FALSE>>=
library(dplyr)
library(ggplot2)
library(png)
library(grid)
library(forcats)
library(archivist)

# mywd <- "/Users/michalfutrega/Downloads/project1-2"
mywd <- "~/Dropbox/RiWizualizacja/project1"
plotdir <- "plots/"
setwd(mywd)
load("pisa.RData")
load("functions.RData")
 
# git parameters & archivist
GITusername <- "LRajkowski"
GITpassword <- "temppass100"
GITrepo <- "pisa_arepo"
setLocalRepo(GITrepo)

    
data <- pisa
country <- "Serbia"
question_colname <- "st29q04"
results_colname <- "pv1math"
country_colname <- "cnt"
question_title <- "I do math because I like it"
results_title <- NULL
show_flag1 <- FALSE
show_flag2 <- TRUE
flags_dir <- paste0(mywd, "/flags/")
alpha <- 3
color_boxes <- TRUE
print_weights <- TRUE
legend_position <- "right"
labels_order <- c("Strongly disagree", "Disagree", "Agree", "Strongly agree")
sub_fontsize <- 5
arepo_fontsize <- 5
@

<<results=tex,echo=FALSE>>=
#### INITIAL COMPUTATIONS
countries <- sort(as.character(unique(pisa[,country_colname])) ) # weÅº wszystkie kraje i posortuj
data <- changeColnames(data,
                 oldNames = c(country_colname, results_colname, question_colname),
                 newNames = c("cnt", "results", "question"))
data$question <- ordered(data$question, labels_order)

dataCollapsed <- data %>% 
    mutate(question = fct_collapse(question, 
                           "(Strongly) Agree"=c("Agree", "Strongly agree"),
                         "(Strongly) Disagree"=c("Disagree", "Strongly disagree")))

### not elegant part ####
meansPerCountry <- data %>% 
    group_by(cnt) %>% 
    summarize(m = mean(results))

meansPerCountry$place <- rank(-meansPerCountry$m) ### rank daje liste rankingowa.
max_rank <- max(meansPerCountry$place)


#### TEX ########
########################
### Table of contents
##################
cat("\\begin{frame}[label=toc] 
\\frametitle{List of countries} 
\\begin{multicols}{4}
\\scriptsize
\\tableofcontents
\\end{multicols}
\\end{frame}")


#### A bit o GIT again 
committext <- paste0("cd ", GITrepo, "; git pull")

for(country in countries[1]){
    #### computations for given country ###
    thisCountryBoxplot <- compareBoxplot(
            data, country, "cnt", "results", "question",
            question_title, results_title, show_flag1, flags_dir, alpha, color_boxes, print_weights
    )
    thisCountryBoxplotMD5 <- asave(thisCountryBoxplot)
    thisCountryDensity <- compareDensity(
            dataCollapsed, country, "cnt", "results", "question",
            question_title, results_title, show_flag2, flags_dir, alpha, legend_position
    )
    thisCountryDensityMD5 <- asave(thisCountryDensity)
    thisCountryRankPlot <- compareRank(country, meansPerCountry) 
    thisCountryRankPlotMD5 <- asave(thisCountryRankPlot)
    
    ### TeX ##########
    file1=paste(plotdir, "temp1_", gsub(" ", "", country), ".eps", sep="")
    ggsaveInLatexLoop( thisCountryBoxplot,  file1, 7, 4)
    
    file2=paste(plotdir, "temp2_", gsub(" ", "", country), ".eps", sep="")
    ggsaveInLatexLoop( thisCountryDensity,  file2, 6, 4)
    
    file3=paste(plotdir, "temp3_", gsub(" ", "", country), ".eps", sep="")
    ggsaveInLatexLoop( thisCountryRankPlot, file3, 7, 4)

    thisCountryRank <- meansPerCountry %>% filter(cnt==country) %>% select(place) %>% as.numeric
    cat("\\AddButton")
    cat("\\section{", country, "}")
    cat("\\begin{frame}[t, fragile=singleslide]")
    cat("\\frametitle{", country, "}")
    
    cat("\\vspace*{-.4cm}")
    cat("\\begin{figure}")
    cat("\\begin{minipage}[t]{.52\\textwidth}")
    cat("\\centering")
    cat("\\includegraphics[width=3.2cm, angle=270]{", file1, "}", sep="")
    cat("\\caption*{\\scriptsize 
        {\\bf Boxplots} of the test score.
        The number on the box is the percentage of students within the group.
        It is also indicated by the fill.}")
    cat("\\vspace{-.4cm}")
    cat("\\fontsize{", arepo_fontsize, "}{", 1.2*arepo_fontsize, "}", MD5title(GITusername, GITrepo, thisCountryBoxplotMD5))
    cat("\\end{minipage}")
    cat("\\begin{minipage}[t]{.44\\textwidth}")
    cat("\\centering")
    cat("\\includegraphics[width=3.2cm, angle=270]{", file2, "}", sep="")
    cat("\\caption*{\\scriptsize 
        {\\bf Density estimation} of the test score within the groups of 
        {\\color{red} (strong) likers} and {\\color{blue}(strong) dislikers}.}")
    cat("\\vspace{-.4cm}")
    cat("\\fontsize{", arepo_fontsize, "}{", 1.2*arepo_fontsize, "}", MD5title(GITusername, GITrepo, thisCountryDensityMD5))
    cat("\\end{minipage}")
    cat("\\\\")
    cat("\\vspace{-2.5cm}")
    cat("\\end{figure}")
    
    cat("\\begin{figure}")
    cat("\\centering \\includegraphics[width=6.0cm, height=10.0cm, angle=270]{", file3, "}", sep="")
    cat("\\vspace{-2.5cm}")
    cat("\\caption*{\\scriptsize", country, " mean score is \\ {\\Large\\bf\\color{red}",  
        thisCountryRank, "} out of ", max_rank, " countries}")
    cat("\\vspace*{-.4cm}")
    cat("\\fontsize{", arepo_fontsize, "}{", 1.2*arepo_fontsize, "}", MD5title(GITusername, GITrepo, thisCountryDensityMD5))
    cat("\\end{figure}")
    cat("\\end{frame}")
    
}

### GIT commit and push
committext <- paste0("cd ", GITrepo, "; git add .; git commit -m \"No message\"")
system(committext)
pushtext <- paste0("cd ", GITrepo, "; git push https://", GITusername, ":",
       GITpassword, "@github.com/", GITusername, "/",
       GITrepo, ".git --all")
system(pushtext)
@

\end{document}